name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  packages: write

jobs:

  build:
    runs-on: ubuntu-latest
    environment: shared
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     

      - name: Compute today's date
        run: |
          TODAY=$(date +'%Y.%m.%d')
          echo "TODAY=$TODAY" >> $GITHUB_ENV
          echo "Date: $TODAY"     

      - name: Compute next tag number for today
        run: |
          TAGS=$(git tag --list "${TODAY}.*" || true)
          if [ -n "$TAGS" ]; then
            # extrait le dernier suffixe numérique N, puis incrémente
            LAST_NUM=$(echo "$TAGS" | sed -E 's/.*\.//g' | sort -n | tail -1)
            NEXT_NUM=$((LAST_NUM + 1))
          else
            NEXT_NUM=1
          fi
          NEW_TAG="${TODAY}.${NEXT_NUM}"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "Existing tags for today:"
          echo "$TAGS"
          echo "Next tag will be: $NEW_TAG" 

      - name: Create and push Git tag
        run: |
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG" 

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} 

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ vars.USER_IMAGE }}/helloworld:${{ env.NEW_TAG }}
            ghcr.io/${{ vars.USER_IMAGE }}/helloworld:latest
